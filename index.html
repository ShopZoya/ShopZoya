<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoya - E-commerce Ordering Workflow</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Theme Colors */
        .custom-pink-purple { background-color: #aa168c; }
        .custom-pink-purple-text { color: #aa168c; }
        .custom-pink-purple-border { border-color: #aa168c; }
        
        /* App Container for mobile simulation */
        .app-container {
            max-width: 480px;
            height: 100vh;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Content scrolls within views */
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
            position: relative; /* Context for fixed elements inside */
        }
        
        /* Hide scrollbar for clean UI */
        .scroll-y-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scroll-y-container::-webkit-scrollbar {
            display: none;
        }

        /* Active bottom navigation item styling */
        .nav-item.active .nav-icon { color: #aa168c; }
        .nav-item.active .nav-label { color: #aa168c; font-weight: 600; }
        
        /* Utility to correctly position fixed CTA bars above the h-14 (56px) bottom nav */
        .bottom-nav-offset { bottom: 3.5rem; /* 56px */ } 
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#aa168c',
                        'secondary': '#fef7ff',
                    }
                }
            }
        }
    </script>
</head>
<body>

    <div id="app" class="app-container bg-white">
        <!-- Application views and fixed CTA bars are rendered here -->
    </div>

    <!-- Bottom Navigation Bar (h-14 fixed at bottom-0) -->
    <div id="bottom-nav" class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-200 shadow-lg z-50 mx-auto h-14">
        <div class="flex justify-around items-center h-full">
            <!-- Home -->
            <button onclick="setView('list')" class="nav-item flex flex-col items-center p-2 active w-1/3">
                <i data-lucide="home" class="nav-icon w-5 h-5 text-gray-500"></i>
                <span class="nav-label text-xs text-gray-500">Home</span>
            </button>
            <!-- My Order (Cart/Shipping) -->
            <button onclick="checkCartAndSetView('shipping')" class="nav-item flex flex-col items-center p-2 relative w-1/3">
                <i data-lucide="shopping-bag" class="nav-icon w-5 h-5 text-gray-500"></i>
                <span id="cart-count-badge" class="absolute -top-1 right-[calc(50%-20px)] text-xs font-bold text-white bg-red-500 rounded-full w-4 h-4 flex items-center justify-center hidden"></span>
                <span class="nav-label text-xs text-gray-500">My Orders</span>
            </button>
            <!-- Cancel Request (NEW) -->
            <button onclick="setView('cancel')" class="nav-item flex flex-col items-center p-2 w-1/3">
                <i data-lucide="x-circle" class="nav-icon w-5 h-5 text-gray-500"></i>
                <span class="nav-label text-xs text-gray-500">Cancel</span>
            </button>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- MODAL CONTAINER: State Selection -->
    <!-- ============================================== -->
    <div id="state-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-50 flex items-end justify-center">
        <div class="bg-white w-full max-w-[480px] rounded-t-xl shadow-2xl transform transition-transform duration-300 translate-y-0 max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Select Your State</h3>
                <button onclick="closeModal('state-modal')"><i data-lucide="x" class="w-6 h-6 text-gray-500"></i></button>
            </div>
            <div id="state-list-container" class="overflow-y-auto flex-grow">
                <!-- State options will be rendered here -->
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- MODAL CONTAINER: Quantity Selection -->
    <!-- ============================================== -->
    <div id="quantity-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white w-11/12 max-w-sm rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Select Quantity</h3>
                <button onclick="closeModal('quantity-modal')"><i data-lucide="x" class="w-6 h-6 text-gray-500"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="updateSelectedQuantity(1)" class="w-full text-left p-3 border rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors" data-qty="1">1 piece</button>
                <button onclick="updateSelectedQuantity(2)" class="w-full text-left p-3 border rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors" data-qty="2">2 pieces</button>
                <button onclick="updateSelectedQuantity(3)" class="w-full text-left p-3 border rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors" data-qty="3">3 pieces</button>
                <button onclick="updateSelectedQuantity(4)" class="w-full text-left p-3 border rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors" data-qty="4">4 pieces</button>
                <button onclick="updateSelectedQuantity(5)" class="w-full text-left p-3 border rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors" data-qty="5">5 pieces</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA, STATE, AND CONSTANTS ---

        const APP_NAME = "Zoya";
        
        // Formspree endpoints (UPDATED to use separate IDs)
        const FORMSPREE_ORDER_URL = 'https://formspree.io/f/xblzgwle'; // For placing new orders
        const FORMSPREE_CANCEL_URL = 'https://formspree.io/f/xzzjeodr'; // NEW ID for cancellation requests
        
        // Shipping cost is always 0 (FREE) as requested, regardless of total.
        const SHIPPING_THRESHOLD = 2000; 
        const STANDARD_SHIPPING_FEE = 0; 

        // List of all Indian states and UTs for the dropdown
        const indianStates = [
            "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", 
            "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", 
            "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", 
            "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", 
            "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal",
            "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", 
            "Delhi", "Jammu and Kashmir", "Lakshadweep", "Puducherry", "Ladakh"
        ];
        
        const products = [];
        const categories = ['All', 'Fashion', 'Electronics', 'Home & Decor', 'Beauty'];

        for (let i = 1; i <= 30; i++) {
            const basePrice = 100 + (i * 10);
            let category;

            // Assign categories dynamically
            if (i % 4 === 1) category = 'Fashion';
            else if (i % 4 === 2) category = 'Electronics';
            else if (i % 4 === 3) category = 'Home & Decor';
            else category = 'Beauty';
            
            products.push({
                id: i,
                name: `Stylish Product ${i}`,
                detailName: `${category} Designer Item ${i}`,
                description: `A must-have piece for your collection. Exceptional quality and design. This item is popular among fashion bloggers and is known for its durability and unique style.`,
                price: basePrice,
                originalPrice: 200 + (i * 15),
                discount: `${Math.floor(Math.random() * 30) + 20}% off`,
                rating: (Math.random() * (5 - 3.5) + 3.5).toFixed(1),
                reviews: Math.floor(Math.random() * 50000) + 1000,
                imageUrls: [
                    `35921e050f29af6b7e49425b95be221d.webp=${category.charAt(0)}P${i}+Img+1`,
                    `https://placehold.co/400x400/aa168c/ffffff?text=${category.charAt(0)}P${i}+Img+2`,
                    `https://placehold.co/400x400/1e90ff/ffffff?text=${category.charAt(0)}P${i}+Img+3`,
                    `https://placehold.co/400x400/ff6347/ffffff?text=${category.charAt(0)}P${i}+Img+4`,
                    `https://placehold.co/400x400/32cd32/ffffff?text=${category.charAt(0)}P${i}+Img+5`,
                ],
                selectedImageIndex: 0, 
                selectedColor: "Default Color",
                selectedPrice: basePrice,
                category: category // New category field
            });
        }

        // State variables
        let currentView = 'list';
        let currentProduct = null;
        let cartItems = [];
        let selectedQuantity = 1; // Default selected quantity for product detail view
        let currentCategory = 'All'; // New state for category filter
        let customerDetails = {
            name: '',
            phone: '',
            email: '', 
            address: '',
            pincode: '',
            state: '', // Initial state is empty for 'Select the state' placeholder
            district: '',
            paymentMethod: 'Cash on Delivery',
            orderId: '' // Field for Order ID
        };
        let cancellationOrderId = ''; // NEW: State variable for cancellation Order ID

        // --- UTILITY AND NAVIGATION FUNCTIONS ---
        
        // Function to generate a 10-digit random number string
        function generateRandomNumberString() {
            let result = '';
            for (let i = 0; i < 10; i++) {
                result += Math.floor(Math.random() * 10); // 0 to 9
            }
            return result;
        }

        function updateCartBadge() {
            const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-count-badge');
            const badgeTop = document.getElementById('cart-count-badge-top');
            
            [badge, badgeTop].forEach(b => {
                if (b) {
                    b.textContent = count;
                    b.classList.toggle('hidden', count === 0);
                }
            });
        }

        function formatPrice(price) { 
            // Ensure prices are formatted cleanly without decimal points
            return `₹${Math.round(price).toLocaleString('en-IN')}`; 
        }
        
        // Show a temporary message (used instead of alert/confirm)
        function showMessage(message, type = 'info') {
            const colors = { 'info': 'bg-blue-500', 'success': 'bg-green-500', 'error': 'bg-red-500' };
            const colorClass = colors[type] || colors['info'];
            
            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-4 left-1/2 -translate-x-1/2 ${colorClass} text-white px-4 py-2 rounded-lg shadow-xl z-[110] transition-opacity duration-300 opacity-0`;
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            
            setTimeout(() => messageBox.style.opacity = 1, 10);
            setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => messageBox.remove(), 300);
            }, 3000);
        }

        // NEW: Function to display the Order ID hint message
        function showOrderIdHint() {
            showMessage('If you bought the products, the order ID was sent via email and WhatsApp. Please check there.', 'info');
        }

        function checkCartAndSetView(view) {
            if (view === 'shipping' && cartItems.length === 0) {
                showMessage('Your cart is empty. Please add products first.', 'error');
                setView('list');
                return;
            }
            setView(view);
        }
        
        function setCategory(category) {
            currentCategory = category;
            setView('list'); // Re-render the list view with the new filter
        }

        // NEW: Function to remove an item from the cart
        function removeCartItem(productId) {
            // Find the item to remove
            const itemIndex = cartItems.findIndex(item => item.productId === productId);
            
            if (itemIndex > -1) {
                const removedItemName = cartItems[itemIndex].name;
                cartItems.splice(itemIndex, 1); // Remove the item
                
                showMessage(`Removed "${removedItemName}" from cart.`, 'info');
                updateCartBadge();
                
                // Re-render the current view if it's shipping or review
                if (currentView === 'shipping' || currentView === 'review') {
                    // Check if cart is now empty and redirect if necessary
                    checkCartAndSetView(currentView);
                } else {
                     // If user somehow triggers this on list/detail view, just update badge
                     setView('list');
                }
            }
        }


        // Main view rendering function
        function setView(view, productId = null) {
            currentView = view;
            
            if (view === 'detail' && productId !== null) {
                currentProduct = products.find(p => p.id === productId);
                selectedQuantity = 1; // Reset quantity on new product view
            } else if (view !== 'detail') {
                currentProduct = null;
            }

            const app = document.getElementById('app');
            app.innerHTML = ''; // Clear existing content

            let mainContentHtml = '';
            let ctaBarHtml = '';

            if (view === 'list') {
                mainContentHtml = renderProductListContent();
            } else if (view === 'detail') {
                const { content, cta } = renderProductDetailContent();
                mainContentHtml = content;
                ctaBarHtml = cta;
            } else if (view === 'shipping') {
                const { content, cta } = renderShippingDetailsContent();
                mainContentHtml = content;
                ctaBarHtml = cta;
            } else if (view === 'review') {
                const { content, cta } = renderReviewContent();
                mainContentHtml = content;
                ctaBarHtml = cta;
            } else if (view === 'confirmation') {
                mainContentHtml = renderConfirmationContent();
            } else if (view === 'cancel') { // Handle cancel view
                const { content, cta } = renderCancelRequestContent();
                mainContentHtml = content;
                ctaBarHtml = cta;
            }


            // Render both the main content and the fixed CTA bar
            app.innerHTML = mainContentHtml + ctaBarHtml;

            // Update nav state
            document.querySelectorAll('.nav-item').forEach(item => { item.classList.remove('active'); });
            if (view === 'list' || view === 'detail') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (view === 'shipping' || view === 'review' || view === 'confirmation') {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            } else if (view === 'cancel') { // Set active state for cancel tab
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
            }

            // Re-render Lucide icons and scroll
            lucide.createIcons();
            app.scrollTop = 0; 
        }

        // --- MODAL FUNCTIONS (Quantity and State) ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modalId === 'state-modal') {
                renderStateOptions();
            }
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function openQuantityModal() {
            document.querySelectorAll('#quantity-modal button').forEach(btn => {
                const qty = parseInt(btn.getAttribute('data-qty'), 10);
                if (qty === selectedQuantity) {
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
            openModal('quantity-modal');
        }

        function updateSelectedQuantity(qty) {
            selectedQuantity = qty;
            const display = document.getElementById('selected-qty-display');
            if (display) {
                display.textContent = qty;
            }
            closeModal('quantity-modal');
        }

        function renderStateOptions() {
            const container = document.getElementById('state-list-container');
            if (!container) return;

            const listHtml = indianStates.map(state => `
                <button onclick="selectState('${state}')" 
                    class="w-full text-left p-4 border-b text-gray-800 hover:bg-gray-50 transition-colors 
                    ${customerDetails.state === state ? 'bg-secondary font-bold custom-pink-purple-text' : ''}">
                    ${state}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="flex flex-col p-2">
                    ${listHtml}
                </div>
            `;
            lucide.createIcons(); 
        }

        function selectState(state) {
            customerDetails.state = state;
            const display = document.getElementById('state-display-text');
            if (display) {
                display.textContent = state;
                display.classList.remove('text-gray-500');
                display.classList.add('text-gray-900', 'font-medium');
            }
            closeModal('state-modal');
        }


        // --- STEP 1: PRODUCT LIST VIEW ---
        
        function renderProductListContent() {
            // Header with Affiliate text
            const header = `
                <header class="sticky top-0 bg-white shadow-md z-10 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h1 class="text-2xl font-bold custom-pink-purple-text">${APP_NAME} Shop</h1>
                            <p class="text-xs text-gray-500 font-medium">Affiliate by Meesho</p>
                        </div>
                        <button onclick="checkCartAndSetView('shipping')" class="relative text-gray-800">
                             <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                             <span id="cart-count-badge-top" class="absolute -top-1 -right-1 text-xs font-bold text-white bg-red-500 rounded-full w-4 h-4 flex items-center justify-center hidden"></span>
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div class="relative flex items-center mb-3">
                        <input type="text" placeholder="Search for products..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                        <i data-lucide="search" class="absolute left-3 w-5 h-5 text-gray-400"></i>
                    </div>

                    <!-- Category Selector -->
                    <div class="flex overflow-x-auto whitespace-nowrap pb-2 scroll-y-container -mx-4 px-4">
                        ${categories.map(category => `
                            <button onclick="setCategory('${category}')" 
                                class="px-4 py-1.5 rounded-full text-sm font-semibold mr-2 transition-colors duration-200
                                ${currentCategory === category 
                                    ? 'bg-primary text-white shadow-md shadow-primary/50' 
                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                ${category}
                            </button>
                        `).join('')}
                    </div>
                </header>
            `;

            // Filter products based on the selected category
            const filteredProducts = products.filter(p => 
                currentCategory === 'All' || p.category === currentCategory
            );

            // Product Cards
            const productCards = filteredProducts.map(p => `
                <div class="w-1/2 p-2" onclick="setView('detail', ${p.id})">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-[1.02] transition-transform cursor-pointer">
                        <div class="relative">
                            <img src="${p.imageUrls[0]}" alt="${p.name}" class="w-full h-48 object-cover">
                        </div>
                        <div class="p-2">
                            <p class="text-xs text-primary font-semibold">${p.category}</p>
                            <p class="font-bold text-sm text-gray-800 truncate">${p.detailName}</p>
                            <div class="flex items-baseline mt-1">
                                <span class="text-lg font-bold text-gray-900">${formatPrice(p.price)}</span>
                                <span class="text-xs text-gray-500 line-through ml-2">${formatPrice(p.originalPrice)}</span>
                                <span class="text-xs text-green-600 ml-2 font-semibold">${p.discount}</span>
                            </div>
                            <div class="flex items-center mt-2 text-xs">
                                <div class="bg-green-600 text-white px-1 py-0.5 rounded flex items-center font-semibold">
                                    ${p.rating} <i data-lucide="star" class="w-3 h-3 ml-0.5 fill-white"></i>
                                </div>
                                <span class="text-gray-500 ml-1">(${p.reviews.toLocaleString()})</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            const productListContent = filteredProducts.length > 0 ? `
                <div class="flex flex-wrap -m-2">
                    ${productCards}
                </div>
            ` : `
                 <div class="text-center p-8 text-gray-500">
                    <i data-lucide="package-x" class="w-10 h-10 mx-auto mb-4"></i>
                    <p class="font-semibold">No products found in the selected category.</p>
                 </div>
            `;

            return `
                ${header}
                <!-- Increased padding bottom to pb-40 for safe scrolling above CTA bar -->
                <div class="flex-grow overflow-y-auto scroll-y-container p-2 pb-40 bg-gray-50"> 
                    <h2 class="text-xl font-semibold p-2 pt-0">Trending ${currentCategory === 'All' ? '' : currentCategory} Products</h2>
                    ${productListContent}
                </div>
            `;
        }


        // --- STEP 2: PRODUCT DETAILS VIEW ---

        function renderProductDetailContent() {
            const product = currentProduct;
            if (!product) { setView('list'); return { content: '', cta: '' }; }

            const imageDots = product.imageUrls.map((_, index) => `
                <span class="w-2 h-2 rounded-full cursor-pointer ${product.selectedImageIndex === index ? 'bg-primary' : 'bg-gray-300'}"
                    onclick="switchProductImage(${index})"></span>
            `).join('');
            
            const detailImages = product.imageUrls.map((url, index) => `
                <img src="${url}" alt="Product Image ${index + 1}" 
                    class="w-20 h-20 object-cover rounded-lg border-2 cursor-pointer ${product.selectedImageIndex === index ? 'border-primary' : 'border-gray-200'}"
                    onerror="this.onerror=null;this.src='https://placehold.co/400x400/aaaaaa/ffffff?text=Image+Error';"
                    onclick="switchProductImage(${index})"
                >
            `).join('');

            const content = `
                <div class="flex-grow flex flex-col h-full overflow-y-auto scroll-y-container">
                    <!-- Top Bar -->
                    <div class="sticky top-0 bg-white p-4 flex items-center justify-between z-20 shadow-sm">
                        <button onclick="setView('list')" class="text-gray-800"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                        <div class="flex-1 text-center font-semibold text-lg">${product.detailName}</div>
                        <i data-lucide="share-2" class="w-5 h-5 text-gray-800"></i>
                    </div>

                    <!-- Main Content Scroll Area - Increased padding bottom to pb-40 for safe scrolling above CTA bar -->
                    <div class="p-4 bg-white space-y-4 flex-grow pb-40"> 
                        
                        <!-- Main Product Image -->
                        <div class="w-full relative bg-gray-100 rounded-xl overflow-hidden shadow-lg">
                            <img id="main-product-image" src="${product.imageUrls[product.selectedImageIndex]}" alt="${product.name}" 
                                class="w-full h-96 object-cover transition-opacity duration-300"
                                onerror="this.onerror=null;this.src='https://placehold.co/400x400/aaaaaa/ffffff?text=Image+Error';"
                            >
                            <div class="absolute bottom-4 left-0 right-0 flex justify-center space-x-2">
                                ${imageDots}
                            </div>
                        </div>

                        <!-- Image Gallery (5 Images) -->
                        <div class="flex space-x-3 overflow-x-auto pb-2 scroll-y-container justify-between">
                            ${detailImages}
                        </div>

                        <!-- Product Description and Price -->
                        <div class="space-y-3 pt-4 border-t border-gray-100">
                            <h1 class="text-xl font-bold text-gray-900">${product.detailName}</h1>

                            <!-- Price Section -->
                            <div class="flex items-center">
                                <span class="text-2xl font-bold text-primary">${formatPrice(product.price)}</span>
                                <span class="text-sm text-gray-500 line-through ml-3">${formatPrice(product.originalPrice)}</span>
                                <span class="text-sm text-green-600 ml-3 font-bold">${product.discount}</span>
                            </div>

                            <!-- Rating -->
                            <div class="flex items-center text-sm">
                                <div class="bg-green-600 text-white px-2 py-0.5 rounded-full flex items-center font-semibold">
                                    ${product.rating} <i data-lucide="star" class="w-3 h-3 ml-1 fill-white"></i>
                                </div>
                                <span class="text-gray-500 ml-2">(${product.reviews.toLocaleString()} reviews)</span>
                            </div>
                            
                            <!-- Quantity Selector (Opens Modal) -->
                            <div class="flex items-center space-x-4 pt-4 border-t mt-4">
                                <label class="text-md font-semibold text-gray-700">Quantity:</label>
                                <button onclick="openQuantityModal()" class="flex items-center border border-gray-300 rounded-lg p-2 px-4 focus:ring-primary focus:border-primary bg-white shadow-sm hover:bg-gray-50 transition-colors">
                                    <span id="selected-qty-display" class="font-bold text-lg">${selectedQuantity}</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 ml-2 text-gray-500"></i>
                                </button>
                            </div>

                            <p class="text-gray-700 pt-2">${product.description}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Fixed Bottom CTA Bar
            const cta = `
                <div id="cta-bar-detail" class="fixed bottom-nav-offset w-full max-w-[480px] mx-auto bg-white border-t p-3 flex justify-center items-center z-40 shadow-2xl">
                    <button onclick="handleAddToCart()" class="flex items-center justify-center bg-primary text-white text-lg font-bold py-3 px-12 rounded-xl w-full transition-all duration-300 hover:opacity-90 shadow-lg shadow-primary/50">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i> Add to Cart
                    </button>
                </div>
            `;

            return { content, cta };
        }

        function handleAddToCart() {
            if (!currentProduct) return;
            
            const selectedQty = selectedQuantity;
            
            const existingItem = cartItems.find(item => item.productId === currentProduct.id);

            if (existingItem) {
                existingItem.quantity += selectedQty; 
                existingItem.price = currentProduct.selectedPrice; 
            } else {
                cartItems.push({
                    productId: currentProduct.id,
                    name: currentProduct.detailName,
                    imageUrl: currentProduct.imageUrls[0],
                    price: currentProduct.selectedPrice, 
                    quantity: selectedQty,
                    originalPrice: currentProduct.originalPrice,
                    discount: currentProduct.discount
                });
            }

            showMessage(`${currentProduct.detailName} added to cart! (Qty: ${selectedQty})`, 'success');
            updateCartBadge();
        }

        function switchProductImage(index) {
            currentProduct.selectedImageIndex = index;
            setView('detail', currentProduct.id); 
        }

        // --- STEP 3 & 4: SHIPPING DETAILS ---
        
        function renderShippingDetailsContent() {
            
            const header = `
                <div class="sticky top-0 bg-white p-4 flex items-center justify-between z-20 shadow-sm">
                    <button onclick="setView('list')" class="text-gray-800"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <div class="flex-1 text-center text-lg font-semibold text-gray-800">Shipping Details</div>
                    <div class="w-6"></div> 
                </div>
            `;
            
            // UPDATED: Added Remove button to cart summary
            const cartSummary = cartItems.map(item => `
                <div class="flex items-center justify-between border-b pb-2 mb-2">
                    <div class="flex items-center">
                        <img src="${item.imageUrl}" class="w-10 h-10 object-cover rounded-md mr-3" alt="Item"
                            onerror="this.onerror=null;this.src='https://placehold.co/100x100/aaaaaa/ffffff?text=Item';">
                        <div class="flex-1">
                            <p class="text-sm text-gray-700 truncate">${item.name} (x${item.quantity})</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-semibold text-gray-900">${formatPrice(item.price * item.quantity)}</span>
                        <!-- NEW: Remove button -->
                        <button onclick="removeCartItem(${item.productId})" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 transition-colors" title="Remove Item">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Input fields
            const formInputs = [
                { id: 'name', label: 'Full Name', type: 'text', required: true, value: customerDetails.name },
                { id: 'email', label: 'Email Address', type: 'email', required: true, value: customerDetails.email }, 
                { id: 'phone', label: 'Phone Number', type: 'tel', required: true, value: customerDetails.phone },
                { id: 'address', label: 'Full Address (House No, Street)', type: 'text', required: true, value: customerDetails.address },
                { id: 'pincode', label: 'Pincode', type: 'number', required: true, value: customerDetails.pincode },
                { id: 'district', label: 'District', type: 'text', required: true, value: customerDetails.district },
            ];

            const formHtml = formInputs.map(input => `
                <div class="mb-4">
                    <label for="${input.id}" class="block text-sm font-medium text-gray-700">${input.label} ${input.required ? '*' : ''}</label>
                    <input type="${input.type}" id="${input.id}" name="${input.id}" 
                        value="${input.value}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                        ${input.required ? 'required' : ''}
                        oninput="updateCustomerDetail('${input.id}', this.value)"
                    >
                </div>
            `).join('');

            // State Selection Button (Opens Modal) 
            const stateDisplay = customerDetails.state || 'Select the state';
            const stateSelectionHtml = `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">State *</label>
                    <button type="button" id="state-display" onclick="openModal('state-modal')" class="mt-1 block w-full text-left px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-white flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <span id="state-display-text" class="${customerDetails.state ? 'text-gray-900 font-medium' : 'text-gray-500'}">${stateDisplay}</span>
                        <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500"></i>
                    </button>
                </div>
            `;


            const content = `
                ${header}
                <!-- Main Content Scroll Area - Increased padding bottom to pb-40 for safe scrolling above CTA bar -->
                <div class="flex-grow overflow-y-auto scroll-y-container bg-gray-50 p-4 pb-40">
                    <div class="bg-white p-4 shadow-sm mb-4 rounded-lg">
                        <h2 class="text-lg font-bold mb-3">Your Items (${cartItems.length})</h2>
                        ${cartSummary}
                        <div class="flex justify-between mt-3 pt-3 border-t border-dashed">
                            <span class="text-xl font-bold">Total:</span>
                            <span class="text-xl font-bold custom-pink-purple-text">${formatPrice(total)}</span>
                        </div>
                    </div>

                    <form id="shipping-form" class="bg-white p-4 shadow-sm mt-4 rounded-lg">
                        <h2 class="text-lg font-bold mb-4 custom-pink-purple-text">Delivery Address</h2>
                        ${formHtml}
                        ${stateSelectionHtml} <!-- Insert State selection button -->
                        
                        <h2 class="text-lg font-bold mt-6 mb-3 custom-pink-purple-text">Payment Method</h2>
                        <div class="flex items-center bg-green-100 p-3 rounded-lg border border-green-300">
                            <i data-lucide="wallet" class="w-5 h-5 mr-3 text-green-700"></i>
                            <span class="font-bold text-green-800">Cash on Delivery (COD) - Mandatory</span>
                        </div>
                    </form>
                </div>
            `;

            // Fixed Bottom Button
            const cta = `
                <div id="cta-bar-shipping" class="fixed bottom-nav-offset w-full max-w-[480px] mx-auto bg-white border-t p-3 flex justify-center items-center z-40 shadow-2xl">
                    <button onclick="handleShippingSubmit()" class="bg-primary text-white text-lg font-bold py-3 px-10 rounded-xl w-full transition-all duration-300 hover:opacity-90 shadow-lg shadow-primary/50">
                        Submit Details & Review Order
                    </button>
                </div>
            `;
            return { content, cta };
        }
        
        function updateCustomerDetail(field, value) {
            customerDetails[field] = value;
        }
        
        function handleShippingSubmit() {
            const requiredFields = ['name', 'phone', 'email', 'address', 'pincode', 'district'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!customerDetails[field] || customerDetails[field].trim() === '') {
                    isValid = false;
                }
            });

            if (customerDetails.state === '') {
                isValid = false;
            }
            
            // Basic validation for Pincode length (6 digits common in India)
            if (customerDetails.pincode && (customerDetails.pincode.length !== 6 || isNaN(customerDetails.pincode))) {
                 isValid = false;
                 showMessage('Pincode must be 6 digits.', 'error');
            }

            if (isValid) {
                // *** Order ID Generation remains here (since it must be generated before Formspree submission) ***
                const randomNumber = generateRandomNumberString();
                customerDetails.orderId = `shopzoya-${randomNumber}`; 
                
                setView('review');
            } else {
                showMessage('Please fill all required fields and select your state correctly.', 'error');
            }
        }


        // --- STEP 5 & 6: ORDER REVIEW VIEW (REMOVED ORDER ID DISPLAY) ---

        function renderReviewContent() {
            // 1. Calculate base total (This is the price the customer actually pays for products)
            const productsTotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // 2. Shipping Cost is always 0 (FREE) as requested
            const shippingCost = 0;

            // 3. Calculate Zoya Offer Price (The doubled/tripled price display to impress the user)
            // Random multiplier between 1.75 and 2.25
            const randomFactor = Math.random() * (2.25 - 1.75) + 1.75;
            const zoyaOfferPrice = Math.round(productsTotal * randomFactor);

            // 4. Calculate Discount (Difference between Zoya Offer Price and actual Products Cost)
            const zoyaDiscount = zoyaOfferPrice - productsTotal; 

            // 5. Calculate Final Grand Total
            const grandTotal = productsTotal + shippingCost; 

            // Header
            const header = `
                <div class="sticky top-0 bg-white p-4 flex items-center justify-between z-20 shadow-sm">
                    <button onclick="setView('shipping')" class="text-gray-800"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <div class="flex-1 text-center text-lg font-semibold text-gray-800">Order Review</div>
                    <div class="w-6"></div> 
                </div>
            `;
            
            // Customer Details Display - Removed Order ID from this section
            const customerDetailsHtml = `
                <div class="bg-white p-4 shadow-sm rounded-lg mb-4">
                    <h2 class="text-lg font-bold mb-3 custom-pink-purple-text">Customer & Delivery Details</h2>
                    <!-- REMOVED: Order ID display is now in Confirmation page -->
                    <p class="text-sm"><span class="font-semibold">Name:</span> ${customerDetails.name}</p>
                    <p class="text-sm"><span class="font-semibold">Email:</span> ${customerDetails.email}</p>
                    <p class="text-sm"><span class="font-semibold">Phone:</span> ${customerDetails.phone}</p>
                    <p class="text-sm"><span class="font-semibold">Address:</span> ${customerDetails.address}, ${customerDetails.district}, ${customerDetails.state} - ${customerDetails.pincode}</p>
                    <p class="text-sm mt-3"><span class="font-semibold">Payment:</span> ${customerDetails.paymentMethod}</p>
                </div>
            `;
            
            // Product List Display (UPDATED: Added Remove button)
            const productListHtml = cartItems.map(item => `
                <div class="flex items-center py-3 border-b border-gray-100">
                    <img src="${item.imageUrl}" class="w-16 h-16 object-cover rounded-md mr-4" alt="Item"
                        onerror="this.onerror=null;this.src='https://placehold.co/100x100/aaaaaa/ffffff?text=Item';">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800 line-clamp-2">${item.name}</p>
                        <p class="text-sm text-gray-500">Unit Price: ${formatPrice(item.price)}</p>
                        <p class="text-sm text-gray-500">Qty: ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-bold text-gray-900">${formatPrice(item.price * item.quantity)}</span>
                         <!-- NEW: Remove button added here too -->
                         <button onclick="removeCartItem(${item.productId})" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 transition-colors" title="Remove Item">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // --- PRICING SUMMARY ---
            const pricingSummaryHtml = `
                <div class="space-y-2 text-md">
                    <!-- Products Cost -->
                    <div class="flex justify-between text-gray-700">
                        <span>Products Cost (${cartItems.length} items)</span>
                        <span class="font-semibold">${formatPrice(productsTotal)}</span>
                    </div>
                    
                    <!-- The Zoya Offer Price (The doubled price display to impress) -->
                    <div class="flex justify-between text-lg font-bold text-red-600 bg-red-50 p-2 rounded-md border border-red-200">
                        <span>Zoya Offer Price:</span>
                        <span class="line-through">${formatPrice(zoyaOfferPrice)}</span>
                    </div>

                    <!-- The Discount applied (Zoya Offer) -->
                    <div class="flex justify-between text-green-600 font-semibold border-b border-dashed pb-2">
                        <span>Zoya Offer Discount (You Saved!)</span>
                        <span>- ${formatPrice(zoyaDiscount)}</span>
                    </div>

                    <!-- Shipping (Always FREE) -->
                    <div class="flex justify-between text-gray-700 pt-2">
                        <span>Shipping Cost</span>
                        <span class="font-semibold text-green-600">
                            FREE (₹0)
                        </span>
                    </div>

                    <!-- Tax (0%) -->
                    <div class="flex justify-between text-gray-700">
                        <span>GST & Tax</span>
                        <span class="font-semibold text-green-600">0%</span>
                    </div>
                </div>

                <!-- Grand Total -->
                <div class="flex justify-between mt-4 pt-4 border-t-2 border-primary">
                    <span class="text-xl font-bold">Grand Total:</span>
                    <span class="text-2xl font-bold custom-pink-purple-text">${formatPrice(grandTotal)}</span>
                </div>
            `;
            // --- END PRICING SUMMARY ---


            const content = `
                ${header}
                <!-- Main Content Scroll Area - Increased padding bottom to pb-40 for safe scrolling above CTA bar -->
                <div class="flex-grow overflow-y-auto scroll-y-container bg-gray-50 p-4 pb-40">
                    
                    ${customerDetailsHtml}

                    <div class="bg-white p-4 shadow-sm rounded-lg mb-4">
                        <h2 class="text-lg font-bold mb-3 custom-pink-purple-text">Selected Products (${cartItems.length})</h2>
                        ${productListHtml}
                    </div>

                    <div class="bg-white p-4 shadow-sm rounded-lg mb-4">
                         <h2 class="text-lg font-bold mb-4 custom-pink-purple-text">Price Details</h2>
                         ${pricingSummaryHtml}
                    </div>
                </div>
            `;

            // Fixed Bottom Button (Place Order)
            const cta = `
                <div id="cta-bar-review" class="fixed bottom-nav-offset w-full max-w-[480px] mx-auto bg-white border-t p-3 flex justify-center items-center z-40 shadow-2xl">
                    <button id="place-order-btn" onclick="placeOrder()" class="bg-primary text-white text-lg font-bold py-3 px-10 rounded-xl w-full transition-all duration-300 hover:opacity-90 shadow-lg shadow-primary/50 flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2" id="order-icon"></i> 
                        <span id="order-text">Place Order</span>
                    </button>
                </div>
            `;

            return { content, cta };
        }

        async function placeOrder() {
            const btn = document.getElementById('place-order-btn');
            const icon = document.getElementById('order-icon');
            const text = document.getElementById('order-text');
            
            const productsTotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const grandTotal = productsTotal; // Since shipping is 0

            // 1. Show Loading State
            btn.setAttribute('disabled', 'true');
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            text.textContent = 'Submitting...';
            // Set icon to loader and start spin animation
            icon.classList.remove('animate-spin'); 
            icon.setAttribute('data-lucide', 'loader-circle'); 
            lucide.createIcons();
            icon.classList.add('animate-spin'); 

            // 2. Construct Form Data for Formspree
            const formData = {
                // *** Order ID is sent to Formspree here ***
                'Order ID': customerDetails.orderId, 
                'Customer Name': customerDetails.name,
                'Email': customerDetails.email,
                'Phone': customerDetails.phone,
                'Shipping Address': `${customerDetails.address}, ${customerDetails.district}, ${customerDetails.state} - ${customerDetails.pincode}`,
                'Payment Method': customerDetails.paymentMethod,
                'Products Summary': cartItems.map(item => 
                    `${item.name} | Qty: ${item.quantity} | Total: ${formatPrice(item.price * item.quantity)}`
                ).join('\n---\n'),
                'Products Subtotal': formatPrice(productsTotal),
                'Shipping Cost': 'FREE (₹0)',
                'Grand Total Paid': formatPrice(grandTotal),
                '_subject': `New Order (${customerDetails.orderId}) from ${customerDetails.name} - ${formatPrice(grandTotal)}`, 
            };

            // 3. Send data to Formspree (Uses FORMSPREE_ORDER_URL)
            try {
                const response = await fetch(FORMSPREE_ORDER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                // 4. Handle Success
                if (response.ok) {
                    showMessage('Order placed successfully! Confirmation sent.', 'success');

                    // Stop loader, show success checkmark briefly
                    icon.classList.remove('animate-spin');
                    icon.setAttribute('data-lucide', 'check-circle'); 
                    lucide.createIcons();
                    text.textContent = 'Order Placed!';
                    
                    // Delay transition slightly to let user see success state
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // The order ID is stored in customerDetails.orderId before clearing the cart
                    const tempOrderId = customerDetails.orderId; // Store it for confirmation page display
                    
                    // Clear cart and reset customer details (except orderId will be used for confirmation)
                    customerDetails = { ...customerDetails, name: '', phone: '', email: '', address: '', pincode: '', state: '', district: '', paymentMethod: 'Cash on Delivery' };
                    // Re-set the orderId from the temp variable 
                    customerDetails.orderId = tempOrderId; 

                    cartItems = []; // Clear the cart
                    updateCartBadge();
                    
                    setView('confirmation');

                } else {
                    // 5. Handle Formspree Error
                    const errorData = await response.json();
                    console.error('Formspree submission error:', errorData);
                    showMessage('Order submission failed. Please check your details.', 'error');
                    
                    // Reset button state on failure
                    btn.removeAttribute('disabled');
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    icon.classList.remove('animate-spin');
                    icon.setAttribute('data-lucide', 'check-circle'); 
                    lucide.createIcons();
                    text.textContent = 'Place Order';
                }

            } catch (error) {
                // 6. Handle Network Error
                console.error('Network or server error during order placement:', error);
                showMessage('Network error. Could not place order.', 'error');
                
                // Reset button state on failure
                btn.removeAttribute('disabled');
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                icon.classList.remove('animate-spin');
                icon.setAttribute('data-lucide', 'check-circle'); 
                lucide.createIcons();
                text.textContent = 'Place Order';
            }
        }


        // --- NEW: ORDER CANCELLATION VIEW ---

        function renderCancelRequestContent() {
            const header = `
                <div class="sticky top-0 bg-white p-4 flex items-center justify-between z-20 shadow-sm">
                    <button onclick="setView('list')" class="text-gray-800"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <div class="flex-1 text-center text-lg font-semibold text-gray-800">Order Cancellation</div>
                    <div class="w-6"></div> 
                </div>
            `;

            const content = `
                ${header}
                <div class="flex-grow overflow-y-auto scroll-y-container bg-gray-50 p-4 pb-40">
                    <div class="bg-white p-4 shadow-sm rounded-lg mb-6">
                        <h2 class="text-lg font-bold mb-3 text-red-600">Cancellation Policy</h2>
                        <p class="text-sm text-gray-700 font-medium p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <span class="font-bold text-red-700">Note:</span> If your order hasn't been shipped, it will be cancelled. Otherwise, it won't be cancelled.
                        </p>
                    </div>
                    
                    <div class="bg-white p-4 shadow-sm rounded-lg">
                        <h2 class="text-lg font-bold mb-4 custom-pink-purple-text">Enter Order Details</h2>
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-between">
                                <label for="cancel-order-id" class="block text-sm font-medium text-gray-700">Enter Order ID *</label>
                                <!-- NEW: Information icon with click handler -->
                                <button onclick="showOrderIdHint()" type="button" class="text-primary hover:text-red-500 transition-colors">
                                    <i data-lucide="info" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <input type="text" id="cancel-order-id" 
                                value="${cancellationOrderId}"
                                oninput="cancellationOrderId = this.value"
                                placeholder="e.g., shopzoya-1234567890 (10 digits)"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                                required
                            >
                        </div>

                        <div class="mb-4">
                            <label for="cancel-reason" class="block text-sm font-medium text-gray-700">Reason for Cancellation (Optional)</label>
                            <textarea id="cancel-reason" rows="3"
                                placeholder="Optional: Enter a brief reason for cancellation..."
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                            ></textarea>
                        </div>
                    </div>
                </div>
            `;

            const cta = `
                <div id="cta-bar-cancel" class="fixed bottom-nav-offset w-full max-w-[480px] mx-auto bg-white border-t p-3 flex justify-center items-center z-40 shadow-2xl">
                    <button onclick="handleCancelRequest()" id="cancel-request-btn" class="bg-red-500 text-white text-lg font-bold py-3 px-10 rounded-xl w-full transition-all duration-300 hover:bg-red-600 shadow-lg shadow-red-500/50 flex items-center justify-center">
                        <i data-lucide="x-octagon" class="w-5 h-5 mr-2" id="cancel-icon"></i> 
                        <span id="cancel-text">Cancel Request</span>
                    </button>
                </div>
            `;

            return { content, cta };
        }

        async function handleCancelRequest() {
            const orderId = cancellationOrderId.trim();
            const reason = document.getElementById('cancel-reason')?.value.trim() || 'No reason provided';
            const btn = document.getElementById('cancel-request-btn');
            const icon = document.getElementById('cancel-icon');
            const text = document.getElementById('cancel-text');

            // --- Order ID Validation ---
            const orderIdRegex = /^shopzoya-\d{10}$/; // Required format: 'shopzoya-' followed by 10 digits
            
            if (orderId === '') {
                showMessage('Please enter a valid Order ID to proceed with cancellation.', 'error');
                return;
            }
            
            if (!orderIdRegex.test(orderId)) {
                showMessage('Order ID is wrong or invalid format. Please use the "shopzoya-xxxxxxxxxx" format.', 'error');
                return;
            }
            // --- End Order ID Validation ---


            // 1. Show Loading State
            btn.setAttribute('disabled', 'true');
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            text.textContent = 'Sending Request...';
            icon.classList.remove('animate-spin'); 
            icon.setAttribute('data-lucide', 'loader-circle'); 
            lucide.createIcons();
            icon.classList.add('animate-spin'); 

            // 2. Construct Form Data for Formspree
            const formData = {
                'Order ID for Cancellation': orderId,
                'Cancellation Reason': reason,
                'Action Type': 'ORDER_CANCELLATION_REQUEST',
                '_subject': `CANCELLATION REQUEST for Order ID: ${orderId}`,
            };

            // 3. Send data to Formspree (Uses FORMSPREE_CANCEL_URL)
            try {
                const response = await fetch(FORMSPREE_CANCEL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                // 4. Handle Success
                if (response.ok) {
                    // Show Success Message
                    showMessage('Order request successfully submitted! We will check the status.', 'success');

                    // Stop loader, show success checkmark briefly
                    icon.classList.remove('animate-spin');
                    icon.setAttribute('data-lucide', 'check-circle'); 
                    lucide.createIcons();
                    text.textContent = 'Request Submitted!';
                    
                    // Clear the form fields and re-render to reflect cleared input
                    cancellationOrderId = '';
                    const reasonField = document.getElementById('cancel-reason');
                    if(reasonField) reasonField.value = '';
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    setView('cancel'); 

                } else {
                    // 5. Handle Formspree Error
                    const errorData = await response.json();
                    console.error('Formspree cancellation submission error:', errorData);
                    showMessage('Cancellation request submission failed. Please try again.', 'error');
                    
                    // Reset button state on failure
                    btn.removeAttribute('disabled');
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    icon.classList.remove('animate-spin');
                    icon.setAttribute('data-lucide', 'x-octagon'); 
                    lucide.createIcons();
                    text.textContent = 'Cancel Request';
                }

            } catch (error) {
                // 6. Handle Network Error
                console.error('Network or server error during cancellation request:', error);
                showMessage('Network error. Could not send cancellation request.', 'error');
                
                // Reset button state on failure
                btn.removeAttribute('disabled');
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                icon.classList.remove('animate-spin');
                icon.setAttribute('data-lucide', 'x-octagon'); 
                lucide.createIcons();
                text.textContent = 'Cancel Request';
            }
        }


        // --- STEP 7: ORDER CONFIRMATION VIEW (ORDER ID ADDED HERE) ---

        function renderConfirmationContent() {
            // After successful order, only orderId is guaranteed to be set correctly in state
            const name = customerDetails.name || 'Customer';
            const address = customerDetails.address || 'Your Shipping Address';
            const pincode = customerDetails.pincode || 'Pincode';
            const email = customerDetails.email || 'Email ID';

             return `
                <div class="flex-grow flex flex-col items-center justify-center p-8 text-center bg-white">
                    <i data-lucide="party-popper" class="w-20 h-20 text-green-500 mb-6"></i>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Order Successfully Confirmed!</h1>
                    
                    <!-- *** Order ID Added Here *** -->
                    <p class="text-xl font-extrabold text-red-600 bg-red-50 p-3 rounded-lg border border-red-200 mb-6">
                        Order ID: ${customerDetails.orderId || 'N/A'}
                    </p>
                    <!-- *** End Order ID *** -->

                    <p class="text-lg text-gray-600 mb-8">Thank you for shopping with ${APP_NAME}.</p>
                    
                    <div class="bg-green-50 p-4 rounded-xl mb-8 w-full max-w-xs">
                         <p class="font-semibold text-green-700">Delivery Address:</p>
                         <p class="text-sm text-green-600 mt-1">${name}, ${address}, ${pincode}</p>
                         <p class="text-sm text-green-600 mt-1">Email: ${email}</p>
                    </div>

                    <button onclick="setView('list')" class="bg-primary text-white text-lg font-bold py-3 px-10 rounded-xl transition-all duration-300 hover:opacity-90 shadow-lg shadow-primary/50">
                        Continue Shopping
                    </button>
                    
                    <!-- We use checkCartAndSetView('shipping') but the cart is now empty, so it will redirect to list and show an alert -->
                    <button onclick="checkCartAndSetView('shipping')" class="mt-4 text-primary font-semibold hover:underline">
                        View Order History (Demo)
                    </button>
                </div>
            `;
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            updateCartBadge();
            setView('list'); 
        };

    </script>
</body>
</html>
