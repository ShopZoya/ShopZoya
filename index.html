<!-- 
    ========================================================================================================
    SHOPZOYA E-COMMERCE - SINGLE FILE HTML/TAILWIND/JS APP 
    (UPDATED: Firebase connection uses __firebase_config and __initial_auth_token)
    ========================================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopZoya - E-commerce Ordering Workflow</title>
    <!-- Tailwind CSS-i load seyyavum -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Azhagana icon-kalukkaga Lucide Icons-i load seyyavum -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Theme Colors */
        :root {
            --primary: #aa168c;
            --secondary: #9000a8;
        }

        .custom-pink-purple { background-color: var(--primary); }
        .custom-pink-purple-text { color: var(--primary); }
        .custom-pink-purple-border { border-color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }
        
        /* Mobile simulation-kaana App Container */
        .app-container {
            max-width: 420px;
            margin: auto;
            min-height: 100vh;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #ffffff;
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        /* Header and View Content */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .view-content {
            padding-bottom: 72px; /* Cart button-kku idandhara */
            min-height: calc(100vh - 56px); /* Header height-a adjust panna */
            background-color: #f7f7f7;
        }

        /* Product Card Styles */
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quantity Selector */
        .quantity-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.1s;
        }
    </style>
</head>
<body class="bg-gray-100 p-0 sm:p-4">
    <div id="app" class="app-container">
        <!-- App content here -->
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore-kku Debug logging-a enable seyyavum
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION & GLOBALS ---
        // Canvas environment-il irundhu configuration edukkapadum (Mandatory)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API key environment-aal provide seyyappadum
        let firebaseConfig = {};

        // Environment's configuration-ai use seyyavum
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
            }
        } else {
             // Fallback/Error state. If the environment fails, log the issue.
             console.error("Firebase config (JSON) is missing from environment variables.");
        }

        let db, auth, userId = null;
        let isFirebaseReady = false;

        // Initialize Firebase services and authenticate the user
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase initialization failed: Config is empty.");
                return;
            }

            console.log("Initializing Firebase...");
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Persistence set panna vendiyathillai, adhuku browserLocalPersistence thevai
                // await setPersistence(auth, browserLocalPersistence);

                // Set up the Authentication State listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isFirebaseReady = true;
                        console.log("Firebase connected âœ…, UID:", userId);
                        // Once authenticated, fetch products
                        await fetchProductsFromFirebase(); 
                    } else {
                        // User sign-out aanaalum, idhu oru app-a fetchProducts panna mudiyadhu (UserId ilamal)
                        userId = null;
                        isFirebaseReady = true;
                        console.error("User is signed out or failed to sign in. Data fetching will be skipped.");
                        products.length = 0; // Clear products if sign-out aanaal
                        render();
                    }
                });

                // Use the initial auth token for authentication
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // If no custom token is available, sign in anonymously
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                console.error("Firebase init error:", error);
                // Fallback to local data rendering if firebase fails
                isFirebaseReady = true;
                products.push(...localProducts);
                render();
            }
        }
        
        // Example: Fetch products collection from the correct path
        // Products-ai /artifacts/{appId}/users/{userId}/products-il save seyyavum
        async function fetchProductsFromFirebase() {
            if (!db || !userId) {
                console.log("DB or User ID not ready for fetching.");
                // Still use the local products as a fallback for the UI
                products.push(...localProducts);
                render();
                return;
            }
            
            // Mandatory Firestore Private Data Path
            const productsPath = `artifacts/${appId}/users/${userId}/products`;
            console.log("Fetching products from path:", productsPath);

            try {
                const productsRef = collection(db, productsPath);
                // onSnapshot-ai real-time updates-kku use seyyavum
                onSnapshot(productsRef, (querySnapshot) => {
                    const firebaseProducts = [];
                    querySnapshot.forEach((doc) => {
                        firebaseProducts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Replace local products and refresh UI
                    products.length = 0;
                    products.push(...firebaseProducts);

                    // If no products are found in Firestore, populate with default local products 
                    // and write them back to Firestore for the first time setup.
                    if (products.length === 0) {
                        console.log("No products found. Populating Firestore with default data...");
                        localProducts.forEach(async (product) => {
                             // Use doc.id as the document ID in Firestore if available, otherwise let Firestore generate it
                            const docRef = doc(productsRef, product.id.toString());
                            await setDoc(docRef, product); 
                        });
                        // onSnapshot will handle the rendering once the data is written back
                    } else {
                        render(); // Refresh UI after getting data
                        console.log(`Products fetched (${products.length}) from Firestore successfully.`);
                    }

                }, (error) => {
                    console.error("Error setting up onSnapshot listener:", error);
                    // Use local products if real-time fetching fails
                    products.push(...localProducts);
                    render();
                });
            } catch (err) {
                console.error(`Error initiating Firestore fetch for ${productsPath}:`, err);
                products.push(...localProducts);
                render();
            }
        }
        
        // --- DATA STRUCTURES (Local fallback for initial state) ---
        // Ippo, products-ai Firebase-il irundhu edukkum varai idhu wait pannum.
        const localProducts = [
            // Dummy data for initialization if Firebase is empty or fails
            { id: 1, name: "Luxury Silk Saree", price: 12500, category: 'sarees', image: 'https://placehold.co/400x600/AA168C/ffffff?text=Silk+Saree', description: "Handwoven pure silk saree with intricate zari work. Perfect for weddings and grand occasions. (Local Product)" },
            { id: 2, name: "Premium Cotton Kurti", price: 3500, category: 'kurtis', image: 'https://placehold.co/400x600/9000a8/ffffff?text=Cotton+Kurti', description: "Comfortable and stylish cotton kurti with block print design. Ideal for daily wear. (Local Product)" },
            { id: 3, name: "Designer Lehenga Set", price: 28000, category: 'lehengas', image: 'https://placehold.co/400x600/D016AA/ffffff?text=Lehenga+Set', description: "Embroidered lehenga with a matching choli and dupatta. A showstopper outfit. (Local Product)" },
            { id: 4, name: "Casual Denim Jeans", price: 4500, category: 'jeans', image: 'https://placehold.co/400x600/000000/ffffff?text=Denim+Jeans', description: "High-quality stretchable denim jeans for women. Modern fit. (Local Product)" },
            { id: 5, name: "Embroidered Blouse", price: 5500, category: 'blouses', image: 'https://placehold.co/400x600/AA168C/ffffff?text=Embroidered+Blouse', description: "Custom-fit embroidered blouse for sarees and lehengas. (Local Product)" },
        ];
        
        let products = [];
        let cart = [];
        let categories = ['sarees', 'kurtis', 'lehengas', 'jeans', 'blouses'];
        let currentView = 'home'; // 'home', 'detail', 'cart', 'checkout', 'confirmation'
        let selectedProduct = null;
        let selectedCategory = 'sarees';
        let buyerPhotos = []; // Placeholder for buyer photos
        let showAllBuyerPhotos = false;
        let orderConfirmationDetails = null;

        // --- UTILITY FUNCTIONS ---
        
        const formatPrice = (price) => {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(price);
        };
        
        const getCartTotal = () => {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        };
        
        const getCartItemCount = () => {
            return cart.reduce((count, item) => count + item.quantity, 0);
        };

        const getCategoryName = (key) => {
            return key.charAt(0).toUpperCase() + key.slice(1);
        };

        const renderLoading = () => `
            <div class="flex flex-col items-center justify-center h-64 bg-white rounded-lg p-6 m-4 shadow-lg">
                <div class="spinner"></div>
                <p class="mt-4 text-lg text-gray-700">Loading products...</p>
                <p class="mt-1 text-sm text-gray-500">Connecting to Firebase...</p>
            </div>
        `;

        // --- NAVIGATION & STATE MANAGEMENT ---

        const goBack = () => {
            if (currentView === 'detail' || currentView === 'cart') {
                setView('home');
            } else if (currentView === 'checkout') {
                setView('cart');
            } else if (currentView === 'confirmation') {
                 // Order mudinja piragu home-kku ponga
                setView('home');
            }
        };

        const setView = (view, product = null) => {
            currentView = view;
            selectedProduct = product;
            render();
        };

        const setCategory = (category) => {
            selectedCategory = category;
            setView('home'); // Category-a select panna udane home-kku ponga
        };

        const checkCartAndSetView = () => {
            if (getCartItemCount() === 0) {
                // Custom modal-a use panna vendum (alert() ku badhila)
                showCustomModal('Empty Cart', 'Your cart is empty. Please add some products before checking out.');
            } else {
                setView('checkout');
            }
        };

        const addToCart = (product, quantity = 1) => {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({ ...product, quantity });
            }
            showCustomModal('Added to Cart', `${quantity} x ${product.name} has been added to your cart.`);
            updateCartIcon();
        };

        const updateCartQuantity = (productId, change) => {
            const index = cart.findIndex(item => item.id === productId);
            if (index !== -1) {
                const newQuantity = cart[index].quantity + change;
                if (newQuantity <= 0) {
                    cart.splice(index, 1); // Remove item
                } else {
                    cart[index].quantity = newQuantity;
                }
                updateCartIcon();
                render(); // Cart view-a refresh seyyavum
            }
        };

        const setSelectedQuantity = (quantity) => {
            const quantityInput = document.getElementById('quantity-input');
            if (quantityInput) {
                quantityInput.value = quantity;
            }
        };
        
        // --- CUSTOM MODAL (Alert/Confirm-kku badhila) ---

        const showCustomModal = (title, message) => {
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="document.getElementById('custom-modal').remove()">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm" onclick="event.stopPropagation()">
                        <h3 class="text-xl font-bold text-primary mb-3">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="document.getElementById('custom-modal').remove()" class="w-full py-2 bg-primary text-white font-semibold rounded-lg hover:bg-secondary transition duration-150">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };


        // --- FIREBASE WRITE FUNCTION (Order Confirmation) ---
        async function handleOrderConfirmation() {
            if (!userId || !db) {
                showCustomModal('Error', 'Cannot complete order. Firebase connection is not ready.');
                return;
            }

            const name = document.getElementById('checkout-name').value;
            const address = document.getElementById('checkout-address').value;
            
            if (!name || !address) {
                showCustomModal('Missing Details', 'Please enter your Name and Delivery Address.');
                return;
            }

            const newOrder = {
                userId: userId,
                name: name,
                address: address,
                items: cart.map(item => ({
                    productId: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price
                })),
                total: getCartTotal(),
                status: 'Placed',
                timestamp: new Date().toISOString()
            };

            // Order-ai /artifacts/{appId}/users/{userId}/orders-il save seyyavum
            const ordersPath = `artifacts/${appId}/users/${userId}/orders`;

            try {
                const docRef = await addDoc(collection(db, ordersPath), newOrder);
                
                orderConfirmationDetails = {
                    id: docRef.id,
                    name: newOrder.name,
                    total: newOrder.total
                };

                // Cart-a clear panni, Confirmation view-kku ponga
                cart.length = 0;
                updateCartIcon();
                setView('confirmation');

            } catch (error) {
                console.error("Error writing order to Firestore:", error);
                showCustomModal('Order Failed', 'There was an error placing your order. Please try again.');
            }
        }
        
        // --- RENDERING COMPONENTS ---

        const renderHeader = (title, showBackButton) => `
            <header class="app-header bg-white shadow-md p-4 flex items-center justify-between">
                <div class="flex items-center">
                    ${showBackButton ? `
                        <button onclick="goBack()" class="p-2 mr-2 rounded-full hover:bg-gray-100 transition duration-150 text-primary">
                            <i data-lucide="chevron-left"></i>
                        </button>
                    ` : ''}
                    <h1 class="text-2xl font-bold text-gray-900">${title}</h1>
                </div>
                <div class="flex items-center">
                    ${currentView === 'home' || currentView === 'detail' ? `
                        <button onclick="setView('cart')" class="relative p-2 rounded-full hover:bg-gray-100 transition duration-150 text-primary mr-2">
                            <i data-lucide="shopping-cart"></i>
                            <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
                                ${getCartItemCount()}
                            </span>
                        </button>
                    ` : ''}
                </div>
            </header>
            ${currentView === 'home' ? renderCategories() : ''}
        `;
        
        const updateCartIcon = () => {
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = getCartItemCount();
            }
        };

        const renderCategories = () => `
            <div class="bg-white p-2 border-b border-gray-100 sticky top-[56px] z-5">
                <div class="flex overflow-x-auto space-x-2 pb-2">
                    ${categories.map(cat => `
                        <button onclick="setCategory('${cat}')" class="flex-shrink-0 px-4 py-1 text-sm font-semibold rounded-full transition duration-150
                            ${selectedCategory === cat ? 'bg-primary text-white hover:bg-secondary shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                            ${getCategoryName(cat)}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;

        const renderProductCard = (product) => `
            <div onclick="setView('detail', ${JSON.stringify(product).replace(/"/g, "'")})" 
                 class="product-card bg-white p-3 rounded-xl shadow-md flex flex-col cursor-pointer transition duration-200 h-full">
                <div class="relative w-full h-48 rounded-lg overflow-hidden mb-3">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x600/94A3B8/ffffff?text=Image+Missing'">
                    <span class="absolute top-2 right-2 bg-pink-100 text-primary text-xs font-bold px-3 py-1 rounded-full">${getCategoryName(product.category)}</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 truncate">${product.name}</h3>
                <p class="text-sm text-gray-500 mb-2 line-clamp-2">${product.description}</p>
                <div class="mt-auto flex items-center justify-between">
                    <span class="text-xl font-bold custom-pink-purple-text">${formatPrice(product.price)}</span>
                    <button onclick="event.stopPropagation(); addToCart(${JSON.stringify(product).replace(/"/g, "'")})" class="p-2 bg-primary text-white rounded-full hover:bg-secondary transition duration-150 shadow-md">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        `;

        const renderHomeView = () => {
            const filteredProducts = products.filter(p => p.category === selectedCategory);
            
            if (!isFirebaseReady) {
                return renderLoading();
            }

            if (filteredProducts.length === 0) {
                 return `
                    <div class="p-6 text-center">
                        <i data-lucide="package-x" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                        <h2 class="text-xl font-semibold text-gray-700">No Products Found</h2>
                        <p class="text-gray-500 mt-2">Currently, there are no items in the '${getCategoryName(selectedCategory)}' category.</p>
                        <button onclick="setCategory('sarees')" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition duration-150">
                            View Sarees
                        </button>
                    </div>
                `;
            }

            return `
                <div class="p-4 grid grid-cols-2 gap-4">
                    ${filteredProducts.map(renderProductCard).join('')}
                </div>
            `;
        };

        const renderDetailView = (product) => {
            if (!product) return renderHomeView();
            
            // Generate dummy buyer photos for demo
            const generatedBuyerPhotos = [
                'https://placehold.co/100x100/AA168C/ffffff?text=B1',
                'https://placehold.co/100x100/9000A8/ffffff?text=B2',
                'https://placehold.co/100x100/D016AA/ffffff?text=B3',
                'https://placehold.co/100x100/F06292/ffffff?text=B4',
                'https://placehold.co/100x100/81C784/ffffff?text=B5',
                'https://placehold.co/100x100/64B5F6/ffffff?text=B6',
            ];
            
            const photosToShow = showAllBuyerPhotos ? generatedBuyerPhotos : generatedBuyerPhotos.slice(0, 4);

            const initialQuantity = cart.find(item => item.id === product.id)?.quantity || 1;
            
            return `
                <div class="bg-white pb-6">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-80 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/800x600/94A3B8/ffffff?text=Image+Missing'">
                    
                    <div class="p-4">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">${product.name}</h2>
                        <span class="inline-block bg-primary text-white text-sm font-semibold px-3 py-1 rounded-full mb-4">${getCategoryName(product.category)}</span>
                        
                        <div class="flex items-center justify-between mb-4 border-b pb-4">
                            <span class="text-4xl font-extrabold custom-pink-purple-text">${formatPrice(product.price)}</span>
                            
                            <!-- Quantity Selector -->
                            <div class="flex items-center space-x-3">
                                <label for="quantity-input" class="text-gray-600 font-medium">Qty:</label>
                                <input id="quantity-input" type="number" min="1" value="${initialQuantity}" onchange="setSelectedQuantity(this.value)"
                                    class="w-16 h-10 text-center border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-800 mt-4 mb-2">Product Details</h3>
                        <p class="text-gray-600 leading-relaxed">${product.description}</p>

                        <!-- Buyer Photos Section -->
                        <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Buyer Photos (${generatedBuyerPhotos.length})</h3>
                        <div class="flex flex-wrap gap-3">
                            ${photosToShow.map(photo => `
                                <img src="${photo}" alt="Buyer Photo" class="w-20 h-20 rounded-lg object-cover cursor-pointer hover:opacity-80 transition duration-150"
                                    onclick="openBuyerPhotoModal('${photo}')" onerror="this.onerror=null; this.src='https://placehold.co/100x100/94A3B8/ffffff?text=B?'">
                            `).join('')}
                            
                            ${generatedBuyerPhotos.length > 4 && !showAllBuyerPhotos ? `
                                <button onclick="toggleShowAllBuyerPhotos(true)" class="w-20 h-20 rounded-lg bg-gray-100 text-gray-600 text-sm font-semibold border-2 border-dashed border-gray-300 hover:bg-gray-200 transition duration-150">
                                    +${generatedBuyerPhotos.length - 4} More
                                </button>
                            ` : ''}
                            ${generatedBuyerPhotos.length > 4 && showAllBuyerPhotos ? `
                                <button onclick="toggleShowAllBuyerPhotos(false)" class="w-20 h-20 rounded-lg bg-gray-100 text-gray-600 text-sm font-semibold border-2 border-dashed border-gray-300 hover:bg-gray-200 transition duration-150">
                                    Show Less
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Fixed Add to Cart Button -->
                <div class="fixed bottom-0 left-0 right-0 max-w-sm mx-auto bg-white p-4 shadow-2xl rounded-t-xl">
                    <button id="add-to-cart-btn" onclick="addToCart(selectedProduct, parseInt(document.getElementById('quantity-input').value))" 
                            class="w-full py-3 bg-primary text-white text-lg font-bold rounded-lg hover:bg-secondary transition duration-150 shadow-lg">
                        <i data-lucide="shopping-cart" class="w-5 h-5 inline-block mr-2"></i>
                        Add to Cart
                    </button>
                </div>
            `;
        };

        const openBuyerPhotoModal = (photoUrl) => {
            const existingModal = document.getElementById('photo-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeBuyerPhotoModal()">
                    <div class="w-full max-w-lg" onclick="event.stopPropagation()">
                        <img src="${photoUrl}" alt="Buyer Photo Fullscreen" class="w-full h-auto max-h-[80vh] object-contain rounded-lg shadow-2xl">
                        <button onclick="closeBuyerPhotoModal()" class="absolute top-4 right-4 text-white p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };

        const closeBuyerPhotoModal = () => {
            document.getElementById('photo-modal')?.remove();
        };

        const toggleShowAllBuyerPhotos = (show) => {
            showAllBuyerPhotos = show;
            render(); // Rerender the detail view
        };

        const renderCartView = () => {
            if (getCartItemCount() === 0) {
                return `
                    <div class="p-6 text-center bg-white m-4 rounded-xl shadow-lg">
                        <i data-lucide="shopping-cart" class="w-16 h-16 text-primary mx-auto mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Your Cart is Empty</h2>
                        <p class="text-gray-500 mt-2">Looks like you haven't added anything to your cart yet.</p>
                        <button onclick="setView('home')" class="mt-6 px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition duration-150 shadow-md">
                            Start Shopping
                        </button>
                    </div>
                `;
            }

            return `
                <div class="p-4">
                    <div class="space-y-4 mb-6">
                        ${cart.map(item => `
                            <div class="flex items-center bg-white p-4 rounded-xl shadow-md">
                                <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg mr-4" onerror="this.onerror=null; this.src='https://placehold.co/100x100/94A3B8/ffffff?text=Item'">
                                <div class="flex-grow">
                                    <h3 class="text-md font-semibold text-gray-800">${item.name}</h3>
                                    <p class="text-sm custom-pink-purple-text font-bold">${formatPrice(item.price)}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="updateCartQuantity('${item.id}', -1)" class="quantity-btn bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span class="w-8 text-center font-bold text-gray-800">${item.quantity}</span>
                                    <button onclick="updateCartQuantity('${item.id}', 1)" class="quantity-btn bg-primary text-white hover:bg-secondary">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border-t border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xl font-semibold text-gray-700">Total Items:</span>
                            <span class="text-xl font-bold custom-pink-purple-text">${getCartItemCount()}</span>
                        </div>
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-2xl font-bold text-gray-900">Cart Total:</span>
                            <span class="text-2xl font-extrabold custom-pink-purple-text">${formatPrice(getCartTotal())}</span>
                        </div>
                        
                        <button onclick="checkCartAndSetView()" class="w-full py-4 bg-primary text-white text-xl font-bold rounded-xl hover:bg-secondary transition duration-150 shadow-lg">
                            Proceed to Checkout
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderCheckoutView = () => `
            <div class="p-4">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Order Summary</h2>
                    <div class="space-y-2 mb-4">
                        ${cart.map(item => `
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>${item.name} (x${item.quantity})</span>
                                <span>${formatPrice(item.price * item.quantity)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t mt-4">
                        <span class="text-xl font-bold text-gray-900">Grand Total:</span>
                        <span class="text-2xl font-extrabold custom-pink-purple-text">${formatPrice(getCartTotal())}</span>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Delivery Information</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="checkout-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="checkout-name" placeholder="Enter your full name"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>
                        <div>
                            <label for="checkout-address" class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                            <textarea id="checkout-address" rows="3" placeholder="Enter full address with pincode"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"></textarea>
                        </div>
                        <div>
                            <label for="checkout-payment" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                            <select id="checkout-payment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                <option>Cash on Delivery (COD)</option>
                                <option disabled>Credit/Debit Card (Unavailable)</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="handleOrderConfirmation()" class="w-full mt-8 py-4 bg-primary text-white text-xl font-bold rounded-xl hover:bg-secondary transition duration-150 shadow-lg">
                        Confirm Order & Pay ${formatPrice(getCartTotal())}
                    </button>
                </div>
            </div>
        `;

        const renderConfirmationView = () => {
            if (!orderConfirmationDetails) {
                return `
                    <div class="p-6 text-center bg-white m-4 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-red-600">Error</h2>
                        <p class="text-gray-500 mt-2">No order details found. Something went wrong.</p>
                        <button onclick="setView('home')" class="mt-6 px-6 py-3 bg-primary text-white rounded-lg hover:bg-secondary">
                            Go Home
                        </button>
                    </div>
                `;
            }

            return `
                <div class="p-4 flex flex-col items-center text-center">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mt-10">
                        <i data-lucide="check-circle" class="w-20 h-20 text-green-500 mx-auto mb-6"></i>
                        <h2 class="text-3xl font-bold text-gray-900 mb-3">Order Placed Successfully!</h2>
                        <p class="text-gray-600 mb-6">Thank you, <span class="font-semibold">${orderConfirmationDetails.name}</span>! Your order has been confirmed.</p>
                        
                        <div class="text-left space-y-2 p-4 bg-gray-50 rounded-lg mb-6">
                            <p class="text-lg font-medium text-gray-700">Order ID: <span class="font-bold text-primary">${orderConfirmationDetails.id.substring(0, 10)}...</span></p>
                            <p class="text-lg font-medium text-gray-700">Total Amount: <span class="font-bold text-primary">${formatPrice(orderConfirmationDetails.total)}</span></p>
                        </div>

                        <p class="text-sm text-gray-500 mb-8">We will send a confirmation email shortly. Your order will be processed and dispatched soon.</p>
                        
                        <button onclick="setView('home')" class="w-full py-3 bg-primary text-white text-lg font-bold rounded-lg hover:bg-secondary transition duration-150 shadow-md">
                            Continue Shopping
                        </button>
                    </div>
                </div>
            `;
        };

        const attachDetailListeners = () => {
             // Inga dhan detail view-kku thevaiyana listeners-ai attach seyyavum.
             // Ippodhikku, quantity input-a mattum handle seyyalam.
            const quantityInput = document.getElementById('quantity-input');
            if (quantityInput) {
                // Ensure the quantity is always at least 1
                quantityInput.addEventListener('change', (e) => {
                    let val = parseInt(e.target.value);
                    if (isNaN(val) || val < 1) {
                        e.target.value = 1;
                    }
                });
            }
        };

        // --- MAIN RENDER FUNCTION ---
        const render = () => {
            const app = document.getElementById('app');
            let content = '';
            let headerTitle = 'ShopZoya';
            let showBack = false;

            if (!isFirebaseReady) {
                 // Firebase ready aagum varai loading-a kaattavum
                 content = renderLoading();
                 headerTitle = 'Connecting...';
                 showBack = false;
            }
            else if (currentView === 'home') {
                content = renderHomeView();
                headerTitle = 'ShopZoya';
                showBack = false;
            } else if (currentView === 'detail' && selectedProduct) {
                content = renderDetailView(selectedProduct);
                headerTitle = 'Product Details';
                showBack = true;
            } else if (currentView === 'cart') {
                content = renderCartView();
                headerTitle = 'Your Shopping Cart';
                showBack = true;
            } else if (currentView === 'checkout') {
                content = renderCheckoutView();
                headerTitle = 'Checkout';
                showBack = true;
            } else if (currentView === 'confirmation') {
                content = renderConfirmationView();
                headerTitle = 'Order Confirmed';
                showBack = true;
            } else {
                content = renderHomeView(); // Default to home if state is unclear
                headerTitle = 'ShopZoya';
                showBack = false;
            }
            
            // Final DOM update
            const headerHtml = renderHeader(headerTitle, showBack);
            app.innerHTML = headerHtml + `<div class="view-content" id="view-content">${content}</div>`;

            // Lucide icons-i re-initialize seyyavum (new content-kaaga)
            lucide.createIcons();
            updateCartIcon();
            
            // *** IMPORTANT: Attach listeners after rendering the content ***
            attachDetailListeners(); 
        };

        // --- GLOBAL EXPORTS (Crucial for HTML onclick to work) ---\
        // Window-vil functions-ai attach seyyavum (onclick events-kku thevai)
        window.setView = setView;
        window.setCategory = setCategory; 
        window.goBack = goBack;
        window.checkCartAndSetView = checkCartAndSetView;
        window.addToCart = addToCart;
        window.updateCartQuantity = updateCartQuantity;
        window.openBuyerPhotoModal = openBuyerPhotoModal;
        window.closeBuyerPhotoModal = closeBuyerPhotoModal;
        window.toggleShowAllBuyerPhotos = toggleShowAllBuyerPhotos;
        window.setSelectedQuantity = setSelectedQuantity;
        window.handleOrderConfirmation = handleOrderConfirmation;
        window.formatPrice = formatPrice; 
        window.showCustomModal = showCustomModal; // Modal function-um export seyyavum

        // --- AARAMBAM (App Start) ---\
        window.onload = function () {
            initializeFirebase(); // Firebase connection-ai start seyyavum
            // render() call, initializeFirebase-kku ullirundhu, auth state mariya piragu varum.
        }

    </script>
</body>
</html>

